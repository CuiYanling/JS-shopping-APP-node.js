<!DOCTYPE html>
<HTML>

<HEAD>
    <TITLE> ZTREE DEMO - beforeEditName / beforeRemove / onRemove / beforeRename / onRename</TITLE>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <link rel="stylesheet" href="css/demo.css" type="text/css">
    <link rel="stylesheet" href="css/zTreeStyle/zTreeStyle.css" type="text/css">
    <script type="text/javascript" src="js/jquery-3.2.1.min.js"></script>
    <script type="text/javascript" src="js/jquery.ztree.core.js"></script>
    <script type="text/javascript" src="js/jquery.ztree.excheck.js"></script>
    <script type="text/javascript" src="js/jquery.ztree.exedit.js"></script>
    <SCRIPT type="text/javascript">
    var setting = {
        view: {
            addHoverDom: addHoverDom,
            removeHoverDom: removeHoverDom,
            selectedMulti: false
        },
        edit: {
            // drag: {
            //     autoExpandTrigger: true,
            //     prev: dropPrev,
            //     inner: dropInner,
            //     next: dropNext
            // },
            enable: true,
            editNameSelectAll: true,
            showRemoveBtn: showRemoveBtn,
            showRenameBtn: showRenameBtn
        },
        data: {
            simpleData: {
                enable: true
            }
        },
        callback: {
            beforeDrag: beforeDrag,
            beforeEditName: beforeEditName,
            beforeRemove: beforeRemove,
            beforeRename: beforeRename,
            onRemove: onRemove,
            onRename: onRename
            // // beforeDrag: beforeDrag,
            // beforeDrop: beforeDrop,
            // beforeDragOpen: beforeDragOpen,
            // onDrag: onDrag,
            // onDrop: onDrop,
            // onExpand: onExpand
        }
    };

    var zNodes = [{
            id: 1,
            pId: 0,
            name: "父节点 1",
            open: true
        },
        {
            id: 11,
            pId: 1,
            name: "叶子节点 1-1"
        },
        {
            id: 12,
            pId: 1,
            name: "叶子节点 1-2"
        },
        {
            id: 13,
            pId: 1,
            name: "叶子节点 1-3"
        },
        {
            id: 2,
            pId: 0,
            name: "父节点 2",
            open: true
        },
        {
            id: 21,
            pId: 2,
            name: "叶子节点 2-1"
        },
        {
            id: 22,
            pId: 2,
            name: "叶子节点 2-2"
        },
        {
            id: 23,
            pId: 2,
            name: "叶子节点 2-3"
        },
        {
            id: 3,
            pId: 0,
            name: "父节点 3",
            open: true
        },
        {
            id: 31,
            pId: 3,
            name: "叶子节点 3-1"
        },
        {
            id: 32,
            pId: 3,
            name: "叶子节点 3-2"
        },
        {
            id: 33,
            pId: 3,
            name: "叶子节点 3-3"
        },{
            id: 4,
            pId: 0,
            name: "父节点 1",
            open: true
        },{
            id: 5,
            pId: 0,
            name: "父节点 1",
            open: true
        },{
            id: 6,
            pId: 0,
            name: "父节点 1",
            open: true
        },{
            id: 7,
            pId: 0,
            name: "父节点 1",
            open: true
        },{
            id: 8,
            pId: 0,
            name: "父节点 1",
            open: true
        },{
            id: 9,
            pId: 0,
            name: "父节点 1",
            open: true
        },{
            id: 10,
            pId: 0,
            name: "父节点 1",
            open: true
        },{
            id: 11,
            pId: 0,
            name: "父节点 1",
            open: true
        }
    ];
    var log, className = "dark";

    function beforeDrag(treeId, treeNodes) {
        return false;
    }

    function beforeEditName(treeId, treeNode) {
        className = (className === "dark" ? "" : "dark");
        showLog("[ " + getTime() + " beforeEditName ]&nbsp;&nbsp;&nbsp;&nbsp; " + treeNode.name);
        var zTree = $.fn.zTree.getZTreeObj("treeDemo");
        zTree.selectNode(treeNode);
        zTree.editName(treeNode);
        return false;
    }

    function beforeRemove(treeId, treeNode) {
        className = (className === "dark" ? "" : "dark");
        showLog("[ " + getTime() + " beforeRemove ]&nbsp;&nbsp;&nbsp;&nbsp; " + treeNode.name);
        var zTree = $.fn.zTree.getZTreeObj("treeDemo");
        zTree.selectNode(treeNode);
        // return confirm("确认删除 节点 -- " + treeNode.name + " 吗？");
    }

    function onRemove(e, treeId, treeNode) {
        showLog("[ " + getTime() + " onRemove ]&nbsp;&nbsp;&nbsp;&nbsp; " + treeNode.name);
    }

    function beforeRename(treeId, treeNode, newName, isCancel) {
        className = (className === "dark" ? "" : "dark");
        showLog((isCancel ? "<span style='color:red'>" : "") + "[ " + getTime() + " beforeRename ]&nbsp;&nbsp;&nbsp;&nbsp; " + treeNode.name + (isCancel ? "</span>" : ""));
        if (newName.length == 0) {
            setTimeout(function() {
                var zTree = $.fn.zTree.getZTreeObj("treeDemo");
                zTree.cancelEditName();
                alert("节点名称不能为空.");
            }, 0);
            return false;
        }
        return true;
    }

    function onRename(e, treeId, treeNode, isCancel) {
        showLog((isCancel ? "<span style='color:red'>" : "") + "[ " + getTime() + " onRename ]&nbsp;&nbsp;&nbsp;&nbsp; " + treeNode.name + (isCancel ? "</span>" : ""));
    }

    function showRemoveBtn(treeId, treeNode) {
        //				return !treeNode.isFirstNode;
        return treeNode
    }

    function showRenameBtn(treeId, treeNode) {
        //				return !treeNode.isLastNode;
        return treeNode
    }

    function showLog(str) {
        if (!log) log = $("#log");
        log.append("<li class='" + className + "'>" + str + "</li>");
        if (log.children("li").length > 8) {
            log.get(0).removeChild(log.children("li")[0]);
        }
    }

    function getTime() {
        var now = new Date(),
            h = now.getHours(),
            m = now.getMinutes(),
            s = now.getSeconds(),
            ms = now.getMilliseconds();
        return (h + ":" + m + ":" + s + " " + ms);
    }

    var newCount = 1;

    function addHoverDom(treeId, treeNode) {
        var sObj = $("#" + treeNode.tId + "_span");
        if (treeNode.editNameFlag || $("#addBtn_" + treeNode.tId).length > 0) return;
        var addStr = "<span class='button add' id='addBtn_" + treeNode.tId +
            "' title='add node' onfocus='this.blur();'></span>";
        sObj.after(addStr);
        var btn = $("#addBtn_" + treeNode.tId);
        if (btn) btn.bind("click", function() {
            var zTree = $.fn.zTree.getZTreeObj("treeDemo");
            zTree.addNodes(treeNode, {
                id: new Date().getTime(),
                pId: treeNode.id,
                name: "new node" + (newCount++)
            });
            return false;
        });
    };

    function removeHoverDom(treeId, treeNode) {
        $("#addBtn_" + treeNode.tId).unbind().remove();
    };

    function selectAll() {
        var zTree = $.fn.zTree.getZTreeObj("treeDemo");
        zTree.setting.edit.editNameSelectAll = $("#selectAll").attr("checked");
    }
    $(document).ready(function() {
        // $.fn.zTree.init($("#treeDemo"), setting, zNodes);
        // $("#selectAll").bind("click", selectAll);
    });
    </SCRIPT>
    <style type="text/css">
    .ztree li span.button.add {
        margin-left: 2px;
        margin-right: -1px;
        background-position: -144px 0;
        vertical-align: top;
        *vertical-align: middle
    }
    </style>
</HEAD>

<BODY>
    <div class="content_wrap">
        <div class="zTreeDemoBackground left">
            <ul id="treeDemo" class="ztree"></ul>
        </div>
        <input type="button" name="reset" id="reset-btn" value="重置" />
        <input type="button" name="" id="save-btn" value="保存" />
        <input type="button" name="" id="add_parentn" value="增加父节点">
    </div>
</BODY>
<script type="text/javascript">
$(window).ready(function() {
    var ztree = $.fn.zTree.init($("#treeDemo"), setting, zNodes);
    $("#add_parentn").click(function(event) {
        var newNodes = { name: "newParentNode1" };
        newNodes = ztree.addNodes(null, newNodes);
    });
    $("#reset-btn").click(function() {
        $.ajax({
            url: '/api/getCategory',
            type: 'get',
            async: true,
            success: function(result) {
                if (result.status) {
                    // alert(result.msg);
                    console.log(result.data);
                    $.fn.zTree.init($("#treeDemo"), setting, result.data);
                } else {
                    alert(result.msg);
                }
            }
        })

        // $("#selectAll").bind("click", selectAll);
    });
    $("#save-btn").click(function() {
        //将树形结构转换成数组
        var nodes = ztree.getNodes();
        var nodes_array = ztree.transformToArray(nodes);
        // 对象合并
        // true深拷贝
        var data = $.extend(true, [], nodes_array);
        $.map(data, function(item) {
            delete item.children;
        })
        console.log(nodes_array)
        console.log(data)
        $.ajax({
            url: '/api/setCategory',
            type: 'post',
            async: true,
            data: { categories: data },
            success: function(result) {
                if (result.status) {
                    console.log(result.msg);
                } else {
                    alert(result.msg);
                }
            }
        })


    })
})
</script>

</HTML>